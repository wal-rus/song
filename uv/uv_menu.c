#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#include "verse.h"
#include "enough.h"
#include "seduce.h"

#include "uv_geometry.h"
#include "uv.h"


void sui_next_node(float pos_x, float pos_y, float red, float green, float blue)
{
	static float array[] = {0.004000, -0.012000, -0.004000, -0.012000, -0.008000, 0.008000, -0.008000, -0.008000, 0.004000, 0.012000, -0.004000, 0.012000, 0.008000, 0.008000, 0.008000, -0.008000, 0.004000, -0.012000, 0.005236, -0.011804, 0.005236, -0.011804, 0.006351, -0.011236, 0.006351, -0.011236, 0.007236, -0.010351, 0.007236, -0.010351, 0.007804, -0.009236, 0.007804, -0.009236, 0.008000, -0.008000, 0.004000, 0.012000, 0.005236, 0.011804, 0.005236, 0.011804, 0.006351, 0.011236, 0.006351, 0.011236, 0.007236, 0.010351, 0.007236, 0.010351, 0.007804, 0.009236, 0.007804, 0.009236, 0.008000, 0.008000, -0.004000, 0.012000, -0.005236, 0.011804, -0.005236, 0.011804, -0.006351, 0.011236, -0.006351, 0.011236, -0.007236, 0.010351, -0.007236, 0.010351, -0.007804, 0.009236, -0.007804, 0.009236, -0.008000, 0.008000, -0.004000, -0.012000, -0.005236, -0.011804, -0.005236, -0.011804, -0.006351, -0.011236, -0.006351, -0.011236, -0.007236, -0.010351, -0.007236, -0.010351, -0.007804, -0.009236, -0.007804, -0.009236, -0.008000, -0.008000, -0.002000, 0.008000, 0.006000, 0.000000, 0.006000, 0.000000, -0.002000, -0.008000, -0.002000, -0.008000, -0.002000, 0.008000};
	glPushMatrix();
	glTranslatef(pos_x, pos_y, 0);
	sui_draw_gl(GL_LINES, array, 54, 2, red, green, blue, 1.0f);
	glPopMatrix();
}

void sui_prev_node(float pos_x, float pos_y, float red, float green, float blue)
{
	static float array[] = {-0.004000, -0.012000, -0.005236, -0.011804, -0.005236, -0.011804, -0.006351, -0.011236, -0.006351, -0.011236, -0.007236, -0.010351, -0.007236, -0.010351, -0.007804, -0.009236, -0.007804, -0.009236, -0.008000, -0.008000, 0.004000, 0.012000, 0.005236, 0.011804, 0.005236, 0.011804, 0.006351, 0.011236, 0.006351, 0.011236, 0.007236, 0.010351, 0.007236, 0.010351, 0.007804, 0.009236, 0.007804, 0.009236, 0.008000, 0.008000, 0.004000, -0.012000, 0.005236, -0.011804, 0.005236, -0.011804, 0.006351, -0.011236, 0.006351, -0.011236, 0.007236, -0.010351, 0.007236, -0.010351, 0.007804, -0.009236, 0.007804, -0.009236, 0.008000, -0.008000, -0.004000, 0.012000, -0.005236, 0.011804, -0.005236, 0.011804, -0.006351, 0.011236, -0.006351, 0.011236, -0.007236, 0.010351, -0.007236, 0.010351, -0.007804, 0.009236, -0.007804, 0.009236, -0.008000, 0.008000, 0.002000, 0.008000, 0.002000, -0.008000, -0.004000, 0.012000, 0.004000, 0.012000, 0.008000, 0.008000, 0.008000, -0.008000, 0.004000, -0.012000, -0.004000, -0.012000, -0.008000, -0.008000, -0.008000, 0.008000, 0.002000, 0.008000, -0.006000, 0.000000, -0.006000, 0.000000, 0.002000, -0.008000};
	glPushMatrix();
	glTranslatef(pos_x, pos_y, 0);
	sui_draw_gl(GL_LINES, array, 54, 2, red, green, blue, 1.0f);
	glPopMatrix();
}

void sui_polygon_select(float pos_x, float pos_y, float red, float green, float blue)
{
	static float array[] = {0.010000, -0.012000, 0.011236, -0.011804, 0.011236, -0.011804, 0.012351, -0.011236, 0.012351, -0.011236, 0.013236, -0.010351, 0.013236, -0.010351, 0.013804, -0.009236, 0.013804, -0.009236, 0.014000, -0.008000, 0.010000, 0.012000, 0.011236, 0.011804, 0.011236, 0.011804, 0.012351, 0.011236, 0.012351, 0.011236, 0.013236, 0.010351, 0.013236, 0.010351, 0.013804, 0.009236, 0.013804, 0.009236, 0.014000, 0.008000, -0.010000, -0.012000, 0.010000, -0.012000, -0.010000, -0.012000, -0.011236, -0.011804, -0.011236, -0.011804, -0.012351, -0.011236, -0.012351, -0.011236, -0.013236, -0.010351, -0.013236, -0.010351, -0.013804, -0.009236, -0.013804, -0.009236, -0.014000, -0.008000, 0.010000, 0.012000, -0.010000, 0.012000, -0.014000, 0.008000, -0.014000, -0.008000, -0.010000, 0.012000, -0.011236, 0.011804, -0.011236, 0.011804, -0.012351, 0.011236, -0.012351, 0.011236, -0.013236, 0.010351, -0.013236, 0.010351, -0.013804, 0.009236, -0.013804, 0.009236, -0.014000, 0.008000, 0.014000, -0.008000, 0.014000, 0.008000, -0.004000, 0.008000, -0.010000, 0.002000, -0.010000, 0.002000, 0.002000, -0.002000, 0.002000, -0.002000, -0.004000, 0.008000, -0.004000, 0.008000, 0.008000, 0.006000, 0.008000, 0.006000, 0.002000, -0.002000, 0.004000, -0.008000, -0.006000, -0.006000, -0.006000, -0.006000, -0.010000, 0.002000, 0.004000, -0.008000, 0.002000, -0.002000, 0.008000, 0.006000, 0.010000, -0.002000, 0.010000, -0.002000, 0.004000, -0.008000};
	glPushMatrix();
	glTranslatef(pos_x, pos_y, 0);
	sui_draw_gl(GL_LINES, array, 68, 2, red, green, blue, 1.0f);
	glPopMatrix();
}

void sui_center(float pos_x, float pos_y, float red, float green, float blue)
{
	static float array[] = {0.010000, -0.012000, 0.011236, -0.011804, 0.011236, -0.011804, 0.012351, -0.011236, 0.012351, -0.011236, 0.013236, -0.010351, 0.013236, -0.010351, 0.013804, -0.009236, 0.013804, -0.009236, 0.014000, -0.008000, 0.010000, -0.012000, -0.010000, -0.012000, -0.010000, -0.012000, -0.011236, -0.011804, -0.011236, -0.011804, -0.012351, -0.011236, -0.012351, -0.011236, -0.013236, -0.010351, -0.013236, -0.010351, -0.013804, -0.009236, -0.013804, -0.009236, -0.014000, -0.008000, -0.014000, -0.008000, -0.014000, 0.008000, -0.010000, 0.012000, -0.011236, 0.011804, -0.011236, 0.011804, -0.012351, 0.011236, -0.012351, 0.011236, -0.013236, 0.010351, -0.013236, 0.010351, -0.013804, 0.009236, -0.013804, 0.009236, -0.014000, 0.008000, -0.010000, 0.012000, 0.010000, 0.012000, 0.014000, 0.008000, 0.014000, -0.008000, 0.010000, 0.012000, 0.011236, 0.011804, 0.011236, 0.011804, 0.012351, 0.011236, 0.012351, 0.011236, 0.013236, 0.010351, 0.013236, 0.010351, 0.013804, 0.009236, 0.013804, 0.009236, 0.014000, 0.008000, -0.008000, -0.008000, -0.008000, 0.008000, -0.008000, 0.008000, 0.008000, 0.008000, 0.008000, 0.008000, 0.008000, -0.008000, 0.008000, -0.008000, -0.008000, -0.008000};
	glPushMatrix();
	glTranslatef(pos_x, pos_y, 0);
	sui_draw_gl(GL_LINES, array, 56, 2, red, green, blue, 1.0f);
	glPopMatrix();
}

void sui_button_uv_create(float pos_x, float pos_y, float red, float green, float blue)
{
	static float array[] = {-0.010000, -0.012000, -0.011236, -0.011804, -0.011236, -0.011804, -0.012351, -0.011236, -0.012351, -0.011236, -0.013236, -0.010351, -0.013236, -0.010351, -0.013804, -0.009236, -0.013804, -0.009236, -0.014000, -0.008000, 0.006000, -0.008000, 0.010000, 0.008000, 0.010000, 0.012000, -0.010000, 0.012000, 0.014000, 0.008000, 0.014000, -0.008000, -0.010000, 0.012000, -0.011236, 0.011804, -0.011236, 0.011804, -0.012351, 0.011236, -0.012351, 0.011236, -0.013236, 0.010351, -0.013236, 0.010351, -0.013804, 0.009236, -0.013804, 0.009236, -0.014000, 0.008000, -0.002000, 0.008000, -0.002000, -0.004000, 0.010000, -0.012000, 0.011236, -0.011804, 0.011236, -0.011804, 0.012351, -0.011236, 0.012351, -0.011236, 0.013236, -0.010351, 0.013236, -0.010351, 0.013804, -0.009236, 0.013804, -0.009236, 0.014000, -0.008000, -0.010000, -0.012000, 0.010000, -0.012000, -0.014000, 0.008000, -0.014000, -0.008000, 0.010000, 0.012000, 0.011236, 0.011804, 0.011236, 0.011804, 0.012351, 0.011236, 0.012351, 0.011236, 0.013236, 0.010351, 0.013236, 0.010351, 0.013804, 0.009236, 0.013804, 0.009236, 0.014000, 0.008000, 0.002000, 0.008000, 0.006000, -0.008000, -0.006000, -0.008000, -0.004764, -0.007804, -0.004764, -0.007804, -0.003649, -0.007236, -0.003649, -0.007236, -0.002764, -0.006351, -0.002764, -0.006351, -0.002196, -0.005236, -0.002196, -0.005236, -0.002000, -0.004000, -0.006000, -0.008000, -0.007236, -0.007804, -0.007236, -0.007804, -0.008351, -0.007236, -0.008351, -0.007236, -0.009236, -0.006351, -0.009236, -0.006351, -0.009804, -0.005236, -0.009804, -0.005236, -0.010000, -0.004000, -0.010000, 0.008000, -0.010000, -0.004000};
	glPushMatrix();
	glTranslatef(pos_x, pos_y, 0);
	sui_draw_gl(GL_LINES, array, 76, 2, red, green, blue, 1.0f);
	glPopMatrix();
}

void sui_button_yz(float pos_x, float pos_y, float red, float green, float blue)
{
	static float array[] = {0.010000, -0.012000, 0.011236, -0.011804, 0.011236, -0.011804, 0.012351, -0.011236, 0.012351, -0.011236, 0.013236, -0.010351, 0.013236, -0.010351, 0.013804, -0.009236, 0.013804, -0.009236, 0.014000, -0.008000, 0.010000, 0.012000, 0.011236, 0.011804, 0.011236, 0.011804, 0.012351, 0.011236, 0.012351, 0.011236, 0.013236, 0.010351, 0.013236, 0.010351, 0.013804, 0.009236, 0.013804, 0.009236, 0.014000, 0.008000, -0.006000, 0.000000, -0.006000, -0.008000, -0.010000, -0.012000, -0.011236, -0.011804, -0.011236, -0.011804, -0.012351, -0.011236, -0.012351, -0.011236, -0.013236, -0.010351, -0.013236, -0.010351, -0.013804, -0.009236, -0.013804, -0.009236, -0.014000, -0.008000, 0.002000, 0.008000, 0.010000, 0.008000, 0.010000, 0.008000, 0.002000, -0.008000, -0.010000, 0.012000, -0.011236, 0.011804, -0.011236, 0.011804, -0.012351, 0.011236, -0.012351, 0.011236, -0.013236, 0.010351, -0.013236, 0.010351, -0.013804, 0.009236, -0.013804, 0.009236, -0.014000, 0.008000, 0.002000, -0.008000, 0.010000, -0.008000, -0.006000, 0.000000, -0.002000, 0.008000, -0.010000, 0.008000, -0.006000, 0.000000, -0.010000, -0.012000, 0.010000, -0.012000, 0.014000, -0.008000, 0.014000, 0.008000, 0.010000, 0.012000, -0.010000, 0.012000, -0.014000, 0.008000, -0.014000, -0.008000};
	glPushMatrix();
	glTranslatef(pos_x, pos_y, 0);
	sui_draw_gl(GL_LINES, array, 60, 2, red, green, blue, 1.0f);
	glPopMatrix();
}

void sui_button_xz(float pos_x, float pos_y, float red, float green, float blue)
{
	static float array[] = {0.010000, -0.012000, 0.011236, -0.011804, 0.011236, -0.011804, 0.012351, -0.011236, 0.012351, -0.011236, 0.013236, -0.010351, 0.013236, -0.010351, 0.013804, -0.009236, 0.013804, -0.009236, 0.014000, -0.008000, -0.010000, 0.008000, -0.002000, -0.008000, -0.010000, -0.012000, -0.011236, -0.011804, -0.011236, -0.011804, -0.012351, -0.011236, -0.012351, -0.011236, -0.013236, -0.010351, -0.013236, -0.010351, -0.013804, -0.009236, -0.013804, -0.009236, -0.014000, -0.008000, 0.010000, -0.008000, 0.002000, -0.008000, 0.010000, 0.008000, 0.002000, 0.008000, 0.002000, -0.008000, 0.010000, 0.008000, -0.002000, 0.008000, -0.010000, -0.008000, 0.010000, 0.012000, 0.011236, 0.011804, 0.011236, 0.011804, 0.012351, 0.011236, 0.012351, 0.011236, 0.013236, 0.010351, 0.013236, 0.010351, 0.013804, 0.009236, 0.013804, 0.009236, 0.014000, 0.008000, 0.014000, 0.008000, 0.014000, -0.008000, 0.010000, -0.012000, -0.010000, -0.012000, -0.014000, -0.008000, -0.014000, 0.008000, -0.010000, 0.012000, 0.010000, 0.012000, -0.010000, 0.012000, -0.011236, 0.011804, -0.011236, 0.011804, -0.012351, 0.011236, -0.012351, 0.011236, -0.013236, 0.010351, -0.013236, 0.010351, -0.013804, 0.009236, -0.013804, 0.009236, -0.014000, 0.008000};
	glPushMatrix();
	glTranslatef(pos_x, pos_y, 0);
	sui_draw_gl(GL_LINES, array, 58, 2, red, green, blue, 1.0f);
	glPopMatrix();
}

void sui_button_xy(float pos_x, float pos_y, float red, float green, float blue)
{
	static float array[] = {0.006000, 0.000000, 0.010000, 0.008000, -0.002000, 0.008000, -0.010000, -0.008000, 0.010000, 0.012000, -0.010000, 0.012000, 0.014000, 0.008000, 0.014000, -0.008000, -0.010000, 0.008000, -0.002000, -0.008000, 0.006000, 0.000000, 0.006000, -0.008000, 0.002000, 0.008000, 0.006000, 0.000000, -0.010000, -0.012000, 0.010000, -0.012000, -0.014000, 0.008000, -0.014000, -0.008000, 0.010000, 0.012000, 0.011236, 0.011804, 0.011236, 0.011804, 0.012351, 0.011236, 0.012351, 0.011236, 0.013236, 0.010351, 0.013236, 0.010351, 0.013804, 0.009236, 0.013804, 0.009236, 0.014000, 0.008000, -0.010000, 0.012000, -0.011236, 0.011804, -0.011236, 0.011804, -0.012351, 0.011236, -0.012351, 0.011236, -0.013236, 0.010351, -0.013236, 0.010351, -0.013804, 0.009236, -0.013804, 0.009236, -0.014000, 0.008000, -0.010000, -0.012000, -0.011236, -0.011804, -0.011236, -0.011804, -0.012351, -0.011236, -0.012351, -0.011236, -0.013236, -0.010351, -0.013236, -0.010351, -0.013804, -0.009236, -0.013804, -0.009236, -0.014000, -0.008000, 0.010000, -0.012000, 0.011236, -0.011804, 0.011236, -0.011804, 0.012351, -0.011236, 0.012351, -0.011236, 0.013236, -0.010351, 0.013236, -0.010351, 0.013804, -0.009236, 0.013804, -0.009236, 0.014000, -0.008000};
	glPushMatrix();
	glTranslatef(pos_x, pos_y, 0);
	sui_draw_gl(GL_LINES, array, 58, 2, red, green, blue, 1.0f);
	glPopMatrix();
}

void sui_button_close(float pos_x, float pos_y, float red, float green, float blue)
{
	static float array[] = {-0.004000, -0.012000, -0.005236, -0.011804, -0.005236, -0.011804, -0.006351, -0.011236, -0.006351, -0.011236, -0.007236, -0.010351, -0.007236, -0.010351, -0.007804, -0.009236, -0.007804, -0.009236, -0.008000, -0.008000, 0.004000, 0.012000, 0.005236, 0.011804, 0.005236, 0.011804, 0.006351, 0.011236, 0.006351, 0.011236, 0.007236, 0.010351, 0.007236, 0.010351, 0.007804, 0.009236, 0.007804, 0.009236, 0.008000, 0.008000, 0.004000, -0.012000, 0.005236, -0.011804, 0.005236, -0.011804, 0.006351, -0.011236, 0.006351, -0.011236, 0.007236, -0.010351, 0.007236, -0.010351, 0.007804, -0.009236, 0.007804, -0.009236, 0.008000, -0.008000, -0.004000, 0.012000, -0.005236, 0.011804, -0.005236, 0.011804, -0.006351, 0.011236, -0.006351, 0.011236, -0.007236, 0.010351, -0.007236, 0.010351, -0.007804, 0.009236, -0.007804, 0.009236, -0.008000, 0.008000, 0.006000, -0.006000, -0.006000, 0.006000, 0.006000, 0.006000, -0.006000, -0.006000, 0.008000, 0.008000, 0.008000, -0.008000, 0.004000, -0.012000, -0.004000, -0.012000, -0.008000, -0.008000, -0.008000, 0.008000, -0.004000, 0.012000, 0.004000, 0.012000};
	glPushMatrix();
	glTranslatef(pos_x, pos_y, 0);
	sui_draw_gl(GL_LINES, array, 52, 2, red, green, blue, 1.0f);
	glPopMatrix();
}


void uv_draw_menu_tool_help(float aspect, float pos, float length, char *text)
{
	if(sui_box_click_test(pos - length * 0.5, aspect - 0.05, length, 0.05))
	{
		sui_draw_2d_line_gl(pos, -0.06, pos * 0.8, -0.18, 0.2, 0.6, 1, 1.0f);
		sui_draw_text(pos * 0.8 - sui_compute_text_length(SUI_T_SIZE, SUI_T_SPACE, text) * 0.5, -0.2, SUI_T_SIZE, SUI_T_SPACE, text, 0.2, 0.6, 1, 1.0);
	}
}

boolean uv_test_menu(BInputState *input)
{
	return input->pointer_y > betray_get_screen_mode(NULL, NULL, NULL) - 0.05;
}

void uv_draw_menu(BInputState *input)
{
	static float aspect, vertex[8] = {1, 0, -1, 0, -1, -0.05, 1, -0.05}, color[16] = {0.1, 0.1, 0.1, 0.5, 0.1, 0.1, 0.1, 0.5, 0.1, 0.1, 0.1, 0.5, 0.1, 0.1, 0.1, 0.5};
	static float t = 0;
	float f;
	ENode *node;
	aspect = betray_get_screen_mode(NULL, NULL, NULL);
	if((node = e_ns_get_node(0, uvg_get_node())) == NULL || V_NT_GEOMETRY != e_ns_get_node_type(node))
		return;	
	
	if(input->mode == BAM_DRAW)
	{
		glPushMatrix();
		glTranslatef(0, aspect, -1);
		sui_set_color_array_gl(color, 4, 4);
		sui_set_blend_gl(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
		sui_draw_gl(GL_QUADS, vertex, 4, 2, 1, 1, 1, 1.0f);
		
		sui_draw_text(-0.98, -0.03, SUI_T_SIZE, SUI_T_SPACE, e_ns_get_node_name(node), 0.2, 0.6, 1, 1.0);

		sui_prev_node(-0.56, -0.025, 0.2, 0.6, 1);
		uv_draw_menu_tool_help(aspect, -0.56, 0.03, "Previous Node");
		sui_next_node(-0.535, -0.025, 0.2, 0.6, 1);
		uv_draw_menu_tool_help(aspect, -0.535, 0.03, "Next Node");

		if(uvg_node_has_uv())
		{
			sui_button_uv_create(-0.5, -0.025, 0.2, 0.2, 0.2);
			uv_draw_menu_tool_help(aspect, -0.5, 0.04, "Node already has UV Layers");
		}else
		{
			t += 0.02;
			f = sin(t) * 0.5 + 0.5;
			sui_button_uv_create(-0.5, -0.025, 0.2 * f + 1 - f, 0.3 * f, 1 * f);
			uv_draw_menu_tool_help(aspect, -0.5, 0.04, "Create UV layers");
		}
		sui_button_xy(0.72, -0.025, 0.2, 0.6, 1);
		uv_draw_menu_tool_help(aspect, 0.72, 0.04, "Project XY");
		sui_button_xz(0.76, -0.025, 0.2, 0.6, 1);
		uv_draw_menu_tool_help(aspect, 0.76, 0.04, "Project XZ");
		sui_button_yz(0.8, -0.025, 0.2, 0.6, 1);
		uv_draw_menu_tool_help(aspect, 0.8, 0.04, "Project YZ");
		sui_button_close(0.98, -0.025, 0.2, 0.6, 1);
		uv_draw_menu_tool_help(aspect, 0.98, 0.03, "Exit");
		glPopMatrix();

	}else
	{
		if(input->mouse_button[0] == FALSE && input->last_mouse_button[0] == TRUE)
		{
			if(sui_box_click_test(-0.575, aspect - 0.05, 0.03, 0.05)) /* Prew node */
			{
				ENode *n, *last;

				n = e_ns_get_node_next(0, 0, V_NT_GEOMETRY);
				if(n != NULL)
				{
					last = n;
					if(e_ns_get_node_id(n) == uvg_get_node())
					{
						for(; n != NULL; n = e_ns_get_node_next(e_ns_get_node_id(n) + 1, 0, V_NT_GEOMETRY))
							last = n;
						uvg_set_node(e_ns_get_node_id(last));
					}else
					{
						for(; e_ns_get_node_id(n) != uvg_get_node(); n = e_ns_get_node_next(e_ns_get_node_id(n) + 1, 0, V_NT_GEOMETRY))
							last = n;
						uvg_set_node(e_ns_get_node_id(last));
					}
				}
			}
			if(sui_box_click_test(-0.55, aspect - 0.05, 0.03, 0.05)) /* Next node */
			{
				ENode *n;
				n = e_ns_get_node_next(uvg_get_node() + 1, 0, V_NT_GEOMETRY);
				if(n == NULL)
					n = e_ns_get_node_next(0, 0, V_NT_GEOMETRY);
				if(n != NULL)
					uvg_set_node(e_ns_get_node_id(n));
			}
			if(!uvg_node_has_uv()) /* CREATE UV */
				if(sui_box_click_test(-0.52, aspect - 0.05, 0.04, 0.05))					
					uvg_node_create_uv();

			if(sui_box_click_test(0.70, aspect - 0.05, 0.04, 0.05))
				uv_tool_project(0, 1, TRUE);
			if(sui_box_click_test(0.74, aspect - 0.05, 0.04, 0.05))
				uv_tool_project(0, 2, TRUE);
			if(sui_box_click_test(0.78, aspect - 0.05, 0.04, 0.05))
				uv_tool_project(2, 1, TRUE);
		}
	}
}
